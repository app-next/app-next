<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>APP NEXT</title>
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --blue: #0033A0;
      --yellow: #FFD700;
      --gray-bg: #f5f5f5;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family:sans-serif; background:var(--gray-bg); color:var(--black); display:flex; flex-direction:column; min-height:100vh; }
    header { background:var(--black); display:flex; justify-content:center; align-items:center; height:60px; }
    header .logo { height:40px; }
    main { flex:1; padding:1rem; max-width:900px; margin:auto; background:var(--white); border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .menu { display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem; width:200px; }
    .menu .btn { width:100%; height:40px; background:var(--blue); color:var(--white); border:none; border-radius:6px; cursor:pointer; }
    .menu .btn:hover { background:var(--yellow); color:var(--black); }
    .submenu { display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem; width:200px; }
    .submenu .subbtn { width:100%; height:40px; background:var(--blue); color:var(--white); border:none; border-radius:6px; cursor:pointer; }
    .submenu .subbtn:hover { background:var(--yellow); color:var(--black); }
    .hidden { display:none !important; }
    form { display:flex; flex-direction:column; gap:0.5rem; max-width:500px; margin:auto; }
    label { font-weight:500; }
    input, select, textarea { padding:0.5rem; border:1px solid #ccc; border-radius:6px; width:100%; }
    input[readonly] { background:#eee; }
    .form-actions { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem; }
    .form-btn { width:120px; height:40px; border:none; border-radius:6px; cursor:pointer; }
    .submit-btn { background:var(--blue); color:var(--white); }
    .submit-btn:hover { background:var(--yellow); color:var(--black); }
    .back-btn { background:#444; color:var(--white); }
    .back-btn:hover { background:var(--yellow); color:var(--black); }
    table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
    th, td { border:1px solid #ccc; padding:0.5rem; text-align:left; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="NEXT Logo" class="logo" />
  </header>
  <main>
    <div id="mainMenu" class="menu">
      <button class="btn" onclick="showSection('ventasMenu')">Ventas</button>
      <button class="btn">CRM</button>
      <button class="btn">Diseños</button>
      <button class="btn">Stock</button>
      <button class="btn">Compras</button>
      <button class="btn">Finanzas</button>
      <button class="btn">Marketing</button>
      <button class="btn">Agenda</button>
      <button class="btn">Reportes</button>
    </div>
    <div id="ventasMenu" class="submenu hidden">
      <button class="subbtn" onclick="showSection('formVenta')">Registrar Venta</button>
      <button class="subbtn" onclick="showSection('clientesRegistrados')">Clientes Registrados</button>
      <button class="subbtn" onclick="showSection('clientesDeuda')">Clientes con Deudas</button>
      <button class="subbtn" onclick="showSection('informeVentas')">Informe de Ventas</button>
      <button class="subbtn back-btn" onclick="showSection('mainMenu')">Volver</button>
    </div>

    <div id="formVenta" class="hidden">
      <h2>Registrar Venta</h2>
      <form onsubmit="return enviarVenta(event)">
        <!-- form fields as previous version -->
        <label>Cliente</label><input list="clientes-list" id="cliente" required /><datalist id="clientes-list"></datalist>
        <label>Teléfono</label><input list="telefonos-list" id="telefono" required /><datalist id="telefonos-list"></datalist>
        <label>Producto</label><input id="producto" required />
        <label>Cantidad</label><input type="number" id="cantidad" min="1" required />
        <label>Precio Unitario</label><input type="number" id="precio" min="0.01" step="0.01" required />
        <label>Total</label><input type="number" id="total" readonly />
        <label>Método de Pago 1</label><select id="metodo1" required>
          <option value="Efectivo_$">Efectivo $</option><option value="BS">BS</option><option value="Zinli">Zinli</option><option value="USDT">USDT</option>
        </select>
        <label>Monto Pago 1</label><input type="number" id="monto1" min="0" step="0.01" required />
        <label>Método de Pago 2 (opcional)</label><select id="metodo2">
          <option value="">Ninguno</option><option value="Efectivo_$">Efectivo $</option><option value="BS">BS</option><option value="Zinli">Zinli</option><option value="USDT">USDT</option>
        </select>
        <label>Monto Pago 2</label><input type="number" id="monto2" min="0" step="0.01" />
        <label>Tasa BCV (ingresar manualmente)</label><input type="number" id="tasa" min="0" step="0.01" />
        <label>Abono Total (USD)</label><input type="number" id="abono" readonly />
        <label>Restante (USD)</label><input type="number" id="restante" readonly />
        <div class="form-actions">
          <button type="button" class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button>
          <button type="submit" class="form-btn submit-btn">Enviar</button>
        </div>
      </form>
    </div>

    <div id="clientesRegistrados" class="hidden">
      <h2>Clientes Registrados</h2><div id="tablaClientes"></div>
      <div class="form-actions"><button class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button></div>
    </div>

    <div id="clientesDeuda" class="hidden">
      <h2>Clientes con Deudas</h2><div id="tablaDeudas"></div>
      <div class="form-actions"><button class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button></div>
    </div>

    <div id="informeVentas" class="hidden">
      <h2>Informe de Ventas</h2><div id="tablaVentas"></div>
      <div class="form-actions"><button class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button></div>
    </div>
  </main>

<script>
const endpoint='https://sheetdb.io/api/v1/7merahzf5ighx';
let ventasData=[], clientesData=[];

function round2(n){return Math.round(n*100)/100;}

async function showSection(id){
  document.querySelectorAll('main > div').forEach(el=>el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(['clientesRegistrados','clientesDeuda','informeVentas'].includes(id)){
    await loadData();
  }
  if(id==='formVenta'){calculateTotal();}
  if(id==='clientesRegistrados'){renderClientes();}
  if(id==='clientesDeuda'){renderDeudas();}
  if(id==='informeVentas'){renderInforme();}
}

async function loadData(){
  try{
    const r=await fetch(endpoint);
    ventasData=await r.json();
    clientesData=ventasData.map(v=>({cliente:v.cliente,telefono:v.telefono}));
    populateDatalists();
  }catch(e){console.error(e);}
}

function populateDatalists(){
  const c=[...new Set(clientesData.map(c=>c.cliente))];
  const t=[...new Set(clientesData.map(c=>c.telefono))];
  document.getElementById('clientes-list').innerHTML=c.map(x=>`<option value="${x}">`).join('');
  document.getElementById('telefonos-list').innerHTML=t.map(x=>`<option value="${x}">`).join('');
}

document.getElementById('cliente').addEventListener('change',()=>{
  const sel=clientesData.find(c=>c.cliente===document.getElementById('cliente').value);
  if(sel)document.getElementById('telefono').value=sel.telefono;
});

function calculateTotal(){
  const c=parseFloat(document.getElementById('cantidad').value)||0;
  const p=parseFloat(document.getElementById('precio').value)||0;
  document.getElementById('total').value=round2(c*p);
  updateAbonoRestante();
}

['cantidad','precio'].forEach(id=>document.getElementById(id).addEventListener('input',calculateTotal));
['metodo1','metodo2','monto1','monto2','tasa'].forEach(id=>document.getElementById(id).addEventListener('input',updateAbonoRestante));

function updateAbonoRestante(){
  const total=parseFloat(document.getElementById('total').value)||0;
  const tasa=parseFloat(document.getElementById('tasa').value)||0;
  let abono=0;
  [{met:'metodo1',amt:'monto1'},{met:'metodo2',amt:'monto2'}].forEach(o=>{
    const method=document.getElementById(o.met).value;
    let val=parseFloat(document.getElementById(o.amt).value)||0;
    if(method==='BS'){ if(tasa>0) val=val/tasa; else val=0; }
    abono+=val;
  });
  abono=round2(abono);
  let restante=round2((parseFloat(document.getElementById('total').value)||0)-abono);
  if(abono<0) abono=0;
  if(restante<0) restante=0;
  document.getElementById('abono').value=abono;
  document.getElementById('restante').value=restante;
}

async function enviarVenta(ev){
  ev.preventDefault();
  const resta=parseFloat(document.getElementById('restante').value);
  if(resta<0){ alert('Revisa montos, hay negativos.'); return false;}
  const payload={data:{
    fecha:new Date().toISOString().split('T')[0],
    cliente:document.getElementById('cliente').value,
    telefono:document.getElementById('telefono').value,
    producto:document.getElementById('producto').value,
    cantidad:parseFloat(document.getElementById('cantidad').value),
    precio_unitario:parseFloat(document.getElementById('precio').value),
    total:parseFloat(document.getElementById('total').value),
    metodo_pago_1:document.getElementById('metodo1').value,
    monto_pago_1:parseFloat(document.getElementById('monto1').value)||0,
    metodo_pago_2:document.getElementById('metodo2').value||'',
    monto_pago_2:parseFloat(document.getElementById('monto2').value)||0,
    tasa_bcv:parseFloat(document.getElementById('tasa').value)||0,
    equivalente_usd_bs:round2((parseFloat(document.getElementById('monto2').value)||0)*(document.getElementById('metodo2').value==='BS'?1/parseFloat(document.getElementById('tasa').value):0)),
    abono:parseFloat(document.getElementById('abono').value),
    restante:parseFloat(document.getElementById('restante').value),
    asesor:document.getElementById('asesor').value,
    comentario:document.getElementById('comentario').value
  }};
  try{
    const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok) throw new Error('HTTP '+r.status);
    alert('Venta registrada con éxito');
    await loadData();
    showSection('ventasMenu');
  }catch(e){console.error(e); alert('Error al registrar la venta');}
  return false;
}

window.addEventListener('DOMContentLoaded',()=>{ loadData(); });
</script>
</body>
</html>