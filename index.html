
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>App NEXT Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    header { background: black; color: white; padding: 10px; text-align: center; }
    main { padding: 20px; max-width: 700px; margin: auto; background: white; border-radius: 10px; }
    input, select, button { display: block; width: 100%; margin: 10px 0; padding: 8px; }
    .subpanel { margin-top: 20px; background: #eaeaea; padding: 15px; border-radius: 10px; }
    #resultado { margin-top: 20px; }
    .volver-btn { background: black; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <header><img src="logo.png" height="50" alt="Logo NEXT" /></header>
  <main>
    <h2>Registrar Venta</h2>
    <form id="formularioVentas" onsubmit="enviarVenta(event)">
      <input list="clientesGuardados" id="cliente" placeholder="Nombre del cliente" required />
      <datalist id="clientesGuardados"></datalist>
      <input id="telefono" placeholder="Teléfono" />
      <input id="producto" placeholder="Producto" />
      <input id="cantidad" type="number" placeholder="Cantidad" />
      <input id="precio" type="number" placeholder="Precio" />
      <select id="metodo1">
        <option value="">Método de pago 1</option>
        <option>Bs</option><option>Divisa</option><option>Pago Móvil</option>
      </select>
      <input id="monto1" type="number" placeholder="Monto de pago 1" />
      <select id="metodo2">
        <option value="Ninguno">Método de pago 2</option>
        <option>Bs</option><option>Divisa</option><option>Pago Móvil</option>
      </select>
      <input id="monto2" type="number" placeholder="Monto de pago 2 (opcional)" />
      <input id="tasa" type="number" placeholder="Tasa BCV (si aplica Bs)" />
      <input id="asesor" placeholder="Asesor (opcional)" />
      <input id="comentario" placeholder="Comentario (opcional)" />
      <button type="submit">Registrar</button>
    </form>

    <div class="subpanel">
      <button onclick="mostrarClientes()">Clientes Registrados</button>
      <button onclick="mostrarDeudas()">Clientes con Deuda</button>
      <button onclick="mostrarInforme()">Informe de Ventas</button>
    </div>

    <div id="resultado"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-Ls632iFhncM7iqfOvJisRKL2xb_xyQo",
      authDomain: "next-app05.firebaseapp.com",
      projectId: "next-app05",
      storageBucket: "next-app05.firebasestorage.app",
      messagingSenderId: "138210783252",
      appId: "1:138210783252:web:7792989863844d40507701",
      measurementId: "G-X9Q7QRZSFN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function enviarVenta(event) {
      event.preventDefault();
      const c = (id) => document.getElementById(id).value.trim();

      const cliente = c("cliente");
      const telefono = c("telefono");
      const producto = c("producto");
      const cantidad = parseFloat(c("cantidad"));
      const precio = parseFloat(c("precio"));
      const metodo1 = c("metodo1");
      const monto1 = parseFloat(c("monto1"));
      const metodo2 = c("metodo2");
      const monto2 = c("monto2") ? parseFloat(c("monto2")) : 0;
      const tasa = c("tasa");
      const asesor = c("asesor");
      const comentario = c("comentario");

      if (!cliente || isNaN(cantidad) || isNaN(precio) || !metodo1 || isNaN(monto1)) {
        alert("Faltan campos obligatorios.");
        return;
      }
      if (monto2 && (metodo2 === "Ninguno" || !metodo2)) {
        alert("Si hay monto de pago 2, debe seleccionarse su método.");
        return;
      }
      if ((metodo1 === "Bs" || metodo2 === "Bs") && !tasa) {
        alert("Si pagas con Bs, debes indicar la tasa BCV.");
        return;
      }

      const total = cantidad * precio;
      const abono = monto1 + monto2;
      const restante = total - abono;

      await addDoc(collection(db, "ventas"), {
        cliente, telefono, producto, cantidad, precio,
        metodo1, monto1, metodo2, monto2,
        tasa, asesor, comentario,
        total, abono, restante
      });

      alert("Venta registrada con éxito.");
      document.getElementById("formularioVentas").reset();
      cargarClientesGuardados(); // actualiza lista
    }

    async function mostrarClientes() {
      const querySnapshot = await getDocs(collection(db, "ventas"));
      let html = "<h3>Clientes Registrados</h3>";
      const clientes = new Set();
      querySnapshot.forEach(doc => {
        const d = doc.data();
        if (!clientes.has(d.cliente)) {
          html += `<p><strong>${d.cliente}</strong> - ${d.telefono}</p>`;
          clientes.add(d.cliente);
        }
      });
      document.getElementById("resultado").innerHTML = html + volverBtn();
    }

    async function mostrarDeudas() {
      const querySnapshot = await getDocs(collection(db, "ventas"));
      let html = "<h3>Clientes con Deuda</h3>";
      querySnapshot.forEach(doc => {
        const d = doc.data();
        if (parseFloat(d.restante) > 0) {
          html += `<p><strong>${d.cliente}</strong> - Deuda: $${d.restante}</p>`;
        }
      });
      document.getElementById("resultado").innerHTML = html + volverBtn();
    }

    async function mostrarInforme() {
      const querySnapshot = await getDocs(collection(db, "ventas"));
      let total = 0;
      querySnapshot.forEach(doc => total += parseFloat(doc.data().total));
      document.getElementById("resultado").innerHTML = `<h3>Informe de Ventas</h3><p>Total vendido: $${total.toFixed(2)}</p>` + volverBtn();
    }

    function volverBtn() {
      return `<button class="volver-btn" onclick="document.getElementById('resultado').innerHTML = ''">Volver</button>`;
    }

    async function cargarClientesGuardados() {
      const querySnapshot = await getDocs(collection(db, "ventas"));
      const datalist = document.getElementById("clientesGuardados");
      datalist.innerHTML = "";
      const datos = {};
      querySnapshot.forEach(doc => {
        const d = doc.data();
        datos[d.cliente] = d.telefono;
      });
      for (const nombre in datos) {
        const opt = document.createElement("option");
        opt.value = nombre;
        opt.setAttribute("data-telefono", datos[nombre]);
        datalist.appendChild(opt);
      }

      document.getElementById("cliente").addEventListener("change", () => {
        const nombre = document.getElementById("cliente").value;
        const tlf = datos[nombre];
        if (tlf) document.getElementById("telefono").value = tlf;
      });
    }

    window.enviarVenta = enviarVenta;
    cargarClientesGuardados();
  </script>
</body>
</html>
