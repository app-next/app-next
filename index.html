
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App NEXT</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f7f7f7; }
        .container { padding: 20px; max-width: 480px; margin: auto; background: #fff; box-shadow: 0 0 10px #ccc; border-radius: 10px; }
        h2, h3 { text-align: center; }
        .panel-btn { display: block; margin: 10px auto; padding: 12px; background: #0077cc; color: white; border: none; border-radius: 5px; width: 100%; font-size: 16px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #logo { width: 100px; display: block; margin: 10px auto; }
        .back-btn { margin-top: 15px; background: #ccc; color: #333; }
    </style>
</head>
<body>
    <div class="container" id="mainPanel">
        <img src="logo.png" alt="Logo NEXT" id="logo">
        <h2>Panel de Ventas</h2>
        <button class="panel-btn" onclick="showPanel('venta')">Registrar venta</button>
        <button class="panel-btn" onclick="showPanel('deuda')">Clientes con deuda</button>
        <button class="panel-btn" onclick="showPanel('registrados')">Clientes registrados</button>
        <button class="panel-btn" onclick="showPanel('informe')">Informe de ventas</button>
    </div>

    <div class="container" id="ventaPanel" style="display:none;">
        <h3>Registrar Venta</h3>
        <form id="ventaForm" onsubmit="enviarVenta(event)">
            <div class="form-group"><label>Cliente</label><input type="text" id="cliente" required></div>
            <div class="form-group"><label>Teléfono</label><input type="tel" id="telefono" required></div>
            <div class="form-group"><label>Producto</label><input type="text" id="producto" required></div>
            <div class="form-group"><label>Cantidad</label><input type="number" id="cantidad" required></div>
            <div class="form-group"><label>Precio Unitario</label><input type="number" step="0.01" id="precio_unitario" required></div>
            <div class="form-group"><label>Total USD</label><input type="number" id="total_usd" readonly></div>
            <div class="form-group"><label>Método Pago 1</label><select id="metodo_pago_1"><option value="">Selecciona</option><option>USD</option><option>BS</option><option>Zinli</option><option>USDT</option></select></div>
            <div class="form-group"><label>Monto Pago 1</label><input type="number" step="0.01" id="monto_pago_1"></div>
            <div class="form-group"><label>Método Pago 2</label><select id="metodo_pago_2"><option value="">Selecciona</option><option>USD</option><option>BS</option><option>Zinli</option><option>USDT</option></select></div>
            <div class="form-group"><label>Monto Pago 2</label><input type="number" step="0.01" id="monto_pago_2"></div>
            <div class="form-group"><label>Tasa BCV</label><input type="number" step="0.01" id="tasa_bcv"></div>
            <div class="form-group"><label>Abono USD</label><input type="number" id="abono_usd" readonly></div>
            <div class="form-group"><label>Restante USD</label><input type="number" id="restante_usd" readonly></div>
            <div class="form-group"><label>Asesor</label><input type="text" id="asesor"></div>
            <div class="form-group"><label>Comentario</label><textarea id="comentario"></textarea></div>
            <button class="panel-btn" type="submit">Enviar</button>
        </form>
        <button class="panel-btn back-btn" onclick="volver()">Volver</button>
    </div>

    <script>
        
        
        function showPanel(id) {
            const panels = ['mainPanel', 'ventaPanel', 'deudaPanel', 'registradosPanel', 'informePanel'];
            panels.forEach(p => {
                const el = document.getElementById(p);
                if (el) el.style.display = 'none';
            });
            const panelId = id + 'Panel';
            const target = document.getElementById(panelId);
            if (target) {
                target.style.display = 'block';
                if (id === 'deuda') cargarLista('deuda', 'deudaLista');
                if (id === 'registrados') cargarLista('registrados', 'registradosLista');
                if (id === 'informe') cargarLista('informe', 'informeVentas');
            } else {
                alert("No se encontró el panel: " + panelId);
            }
        }

        function volver() {
            showPanel('main');
        }

        function cargarLista(tipo, contenedorId) {
            const cont = document.getElementById(contenedorId);
            cont.innerHTML = "Cargando...";
            fetch("https://script.google.com/macros/s/AKfycbwVyOMe5KcCsnkLq2kxDoh4zU42XRYrHD3dwvdw-HF6G1kg8fXC0rNPdhO1Fjy96TFbDg/exec?sheet=Ventas")
                .then(res => res.json())
                .then(data => {
                    if (!Array.isArray(data)) {
                        cont.innerHTML = "Sin datos válidos.";
                        return;
                    }
                    if (tipo === 'deuda') {
                        const deudores = data.filter(row => parseFloat(row.restante_usd) > 0);
                        cont.innerHTML = deudores.length > 0
                            ? deudores.map(r => `<div><b>${r.cliente}</b> - Tel: ${r.telefono} - Debe: ${r.restante_usd}</div>`).join("")
                            : "Sin clientes con deuda.";
                    } else if (tipo === 'registrados') {
                        const clientesUnicos = [...new Set(data.map(r => r.cliente))];
                        cont.innerHTML = clientesUnicos.length > 0
                            ? clientesUnicos.map(c => `<div>${c}</div>`).join("")
                            : "Sin clientes registrados.";
                    } else if (tipo === 'informe') {
                        let total = 0, abono = 0, restante = 0;
                        data.forEach(r => {
                            total += parseFloat(r.total_usd) || 0;
                            abono += parseFloat(r.abono_usd) || 0;
                            restante += parseFloat(r.restante_usd) || 0;
                        });
                        cont.innerHTML = `
                            <div><b>Total Vendido:</b> $${total.toFixed(2)}</div>
                            <div><b>Total Abonado:</b> $${abono.toFixed(2)}</div>
                            <div><b>Total Deuda:</b> $${restante.toFixed(2)}</div>
                        `;
                    }
                })
                .catch(err => {
                    cont.innerHTML = "Error al cargar datos: " + err.message;
                });
        }
)
                .catch(() => {
                    document.getElementById(contenedorId).innerHTML = "Error al cargar los datos.";
                });
        }
)
            .then(res => res.text())
            .then(msg => {
                alert("Venta registrada correctamente.");
                document.getElementById("ventaForm").reset();
                document.getElementById("total_usd").value = "";
                document.getElementById("abono_usd").value = "";
                document.getElementById("restante_usd").value = "";
            })
            .catch(err => {
                alert("Error al registrar la venta: " + err);
            });
        }

        // Cálculo automático
        document.getElementById('cantidad').addEventListener('input', calcularTotal);
        document.getElementById('precio_unitario').addEventListener('input', calcularTotal);
        document.getElementById('monto_pago_1').addEventListener('input', calcularAbono);
        document.getElementById('monto_pago_2').addEventListener('input', calcularAbono);
        function calcularTotal() {
            let cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
            let precio = parseFloat(document.getElementById('precio_unitario').value) || 0;
            let total = cantidad * precio;
            document.getElementById('total_usd').value = total.toFixed(2);
            calcularAbono();
        }
        function calcularAbono() {
            let pago1 = parseFloat(document.getElementById('monto_pago_1').value) || 0;
            let pago2 = parseFloat(document.getElementById('monto_pago_2').value) || 0;
            let total = parseFloat(document.getElementById('total_usd').value) || 0;
            let abono = pago1 + pago2;
            document.getElementById('abono_usd').value = abono.toFixed(2);
            document.getElementById('restante_usd').value = Math.max(0, total - abono).toFixed(2);
        }

        }
        document.getElementById('cantidad').addEventListener('input', calcularTotal);
        document.getElementById('precio_unitario').addEventListener('input', calcularTotal);
        function calcularTotal() {
            let cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
            let precio = parseFloat(document.getElementById('precio_unitario').value) || 0;
            let total = cantidad * precio;
            document.getElementById('total_usd').value = total.toFixed(2);
        }
    </script>

    <div class="container" id="deudaPanel" style="display:none;">
        <h3>Clientes con Deuda</h3>
        <div id="deudaLista">Cargando...</div>
        <button class="panel-btn back-btn" onclick="volver()">Volver</button>
    </div>

    <div class="container" id="registradosPanel" style="display:none;">
        <h3>Clientes Registrados</h3>
        <div id="registradosLista">Cargando...</div>
        <button class="panel-btn back-btn" onclick="volver()">Volver</button>
    </div>

    <div class="container" id="informePanel" style="display:none;">
        <h3>Informe de Ventas</h3>
        <div id="informeVentas">Cargando...</div>
        <button class="panel-btn back-btn" onclick="volver()">Volver</button>
    </div>

</body>
</html>
