<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Ventas - NEXT</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="NEXT Logo" class="logo">
    <h1>Registrar Venta</h1>
    <form id="ventaForm">
      <input type="hidden" name="fecha" id="fecha">
      <input type="text" name="cliente" placeholder="Cliente" required>
      <input type="text" name="telefono" placeholder="Teléfono" required>
      <input type="text" name="producto" placeholder="Producto" required>
      <input type="number" name="cantidad" id="cantidad" placeholder="Cantidad" required>
      <input type="number" name="precio_unitario" id="precio_unitario" placeholder="Precio Unitario" required>
      <input type="text" name="total_usd" id="total_usd" placeholder="Total USD" readonly>
      <select name="metodo_pago_1" id="metodo_pago_1" required>
        <option value="">Método de Pago 1</option>
        <option value="BS">Bolívares (BS)</option>
        <option value="ZELLE">Zelle</option>
        <option value="EFECTIVO">Efectivo</option>
        <option value="PAGO MOVIL">Pago Móvil</option>
        <option value="TRANSFERENCIA">Transferencia</option>
      </select>
      <input type="number" name="monto_pago_1" id="monto_pago_1" placeholder="Monto Pago 1" required>
      <select name="metodo_pago_2" id="metodo_pago_2">
        <option value="">Método de Pago 2 (opcional)</option>
        <option value="BS">Bolívares (BS)</option>
        <option value="ZELLE">Zelle</option>
        <option value="EFECTIVO">Efectivo</option>
        <option value="PAGO MOVIL">Pago Móvil</option>
        <option value="TRANSFERENCIA">Transferencia</option>
      </select>
      <input type="number" name="monto_pago_2" id="monto_pago_2" placeholder="Monto Pago 2 (opcional)">
      <input type="number" name="tasa_bcv" id="tasa_bcv" placeholder="Tasa BCV (si aplica BS)">
      <input type="text" name="abono_usd" id="abono_usd" placeholder="Abono USD" readonly>
      <input type="text" name="restante_usd" id="restante_usd" placeholder="Restante USD" readonly>
      <input type="text" name="asesor" placeholder="Asesor">
      <textarea name="comentario" placeholder="Comentario"></textarea>
      <button type="submit">Registrar</button>
    </form>
    <p id="mensaje"></p>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Auto fill date and time
      const now = new Date();
      document.getElementById('fecha').value = now.toLocaleDateString('es-VE') + ' ' + now.toLocaleTimeString('es-VE');
      // Calculate totals
      const calcFields = ['cantidad','precio_unitario','monto_pago_1','monto_pago_2'];
      calcFields.forEach(id => document.getElementById(id).addEventListener('input', calcularTotales));
      function calcularTotales() {
        const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
        const precio = parseFloat(document.getElementById('precio_unitario').value) || 0;
        const p1 = parseFloat(document.getElementById('monto_pago_1').value) || 0;
        const p2 = parseFloat(document.getElementById('monto_pago_2').value) || 0;
        const total = cantidad * precio;
        const abono = p1 + p2;
        document.getElementById('total_usd').value = total.toFixed(2);
        document.getElementById('abono_usd').value = abono.toFixed(2);
        document.getElementById('restante_usd').value = Math.max(0, total - abono).toFixed(2);
      }
      // Form submission
      document.getElementById('ventaForm').onsubmit = async function(e) {
        e.preventDefault();
        const datos = Object.fromEntries(new FormData(this).entries());
        // Validations
        if ((datos.monto_pago_1 && !datos.metodo_pago_1) || (datos.metodo_pago_1 === 'BS' && !datos.tasa_bcv)) {
          document.getElementById('mensaje').innerText = 'Por favor completa los métodos de pago correctamente.';
          document.getElementById('mensaje').style.color = 'red';
          return;
        }
        try {
          const res = await fetch("https://script.google.com/macros/s/AKfycbxpaVldshku5oRYcyAxpzmeeW6fRZ2OCg0kTiYPS2I7L0bYMoDCSLND-42jcI9yX6u-QA/exec", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(datos) });
          if (res.ok) {
            document.getElementById('mensaje').innerText = '✅ Venta registrada correctamente.';
            document.getElementById('mensaje').style.color = 'green';
            this.reset();
          } else {
            document.getElementById('mensaje').innerText = '❌ Error al registrar la venta.';
            document.getElementById('mensaje').style.color = 'red';
          }
        } catch (err) {
          document.getElementById('mensaje').innerText = '❌ Error de conexión.';
          document.getElementById('mensaje').style.color = 'red';
          console.error(err);
        }
      };
    });
  </script>
</body>
</html>
