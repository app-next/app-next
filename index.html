<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>APP NEXT</title>
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --blue: #0033A0;
      --yellow: #FFD700;
    }
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: var(--white);
      color: var(--black);
    }
    header {
      background: var(--black);
      color: var(--white);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }
    header .logo {
      height: 40px;
    }
    main {
      padding: 1rem;
    }
    .menu, .submenu {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .btn, .subbtn, button {
      padding: 0.75rem 1rem;
      background: var(--blue);
      color: var(--white);
      border: none;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
    }
    .btn:hover, .subbtn:hover, button:hover {
      background: var(--yellow);
      color: var(--black);
    }
    .hidden { display: none !important; }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-width: 400px;
      margin: auto;
    }
    input, select, textarea {
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
    }
    input[readonly] {
      background: #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
    }
    .back-btn {
      background: #444;
    }
    .back-btn:hover {
      background: var(--yellow);
      color: var(--black);
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="NEXT Logo" class="logo" />
    APP NEXT
  </header>
  <main>
    <!-- Menú Principal -->
    <div id="mainMenu" class="menu">
      <button class="btn" onclick="showSection('ventasMenu')">Ventas</button>
      <button class="btn">CRM</button>
      <button class="btn">Diseños</button>
      <button class="btn">Stock</button>
      <button class="btn">Compras</button>
      <button class="btn">Finanzas</button>
      <button class="btn">Marketing</button>
      <button class="btn">Agenda</button>
      <button class="btn">Reportes</button>
    </div>

    <!-- Submenú Ventas -->
    <div id="ventasMenu" class="submenu hidden">
      <button class="subbtn" onclick="showSection('formVenta')">Registrar Venta</button>
      <button class="subbtn" onclick="showSection('clientesRegistrados')">Clientes Registrados</button>
      <button class="subbtn" onclick="showSection('clientesDeuda')">Clientes con Deudas</button>
      <button class="subbtn" onclick="showSection('informeVentas')">Informe de Ventas</button>
      <button class="subbtn back-btn" onclick="showSection('mainMenu')">Volver al Menú Principal</button>
    </div>

    <!-- Formulario Registrar Venta -->
    <div id="formVenta" class="hidden">
      <h2>Registrar Venta</h2>
      <form onsubmit="enviarVenta(event)">
        <label>Cliente:</label>
        <input list="clientes-list" id="cliente" placeholder="Nombre del cliente" required />
        <datalist id="clientes-list"></datalist>

        <label>Teléfono:</label>
        <input list="telefonos-list" id="telefono" placeholder="Número telefónico" required />
        <datalist id="telefonos-list"></datalist>

        <label>Cantidad:</label>
        <input type="number" id="cantidad" placeholder="Cantidad" min="1" required />

        <label>Precio Unitario:</label>
        <input type="number" id="precio" placeholder="Precio unitario" min="0.01" step="0.01" required />

        <label>Total:</label>
        <input type="number" id="total" readonly placeholder="Total calculado" />

        <label>Método de Pago:</label>
        <select id="metodo_pago" required>
          <option value="Efectivo_$">Efectivo $</option>
          <option value="Efectivo_Bs">Efectivo Bs</option>
          <option value="ZINLI">ZINLI</option>
          <option value="USDT">USDT</option>
          <option value="Pago_Móvil">Pago Móvil</option>
        </select>

        <label>Tasa BCV (solo Bs):</label>
        <input type="number" id="tasa" readonly placeholder="Tasa BCV" />

        <label>Abono:</label>
        <input type="number" id="abono" placeholder="Abono realizado" min="0" step="0.01" />

        <label>Restante:</label>
        <input type="number" id="restante" readonly placeholder="Monto restante" />

        <label>Asesor:</label>
        <input type="text" id="asesor" placeholder="Nombre del asesor" required />

        <label>Comentarios:</label>
        <textarea id="comentario" rows="3" placeholder="Comentarios adicionales"></textarea>

        <button type="submit">Enviar</button>
        <button type="button" class="back-btn" onclick="showSection('ventasMenu')">Volver al submenú anterior</button>
      </form>
    </div>

    <!-- Clientes Registrados -->
    <div id="clientesRegistrados" class="hidden">
      <h2>Clientes Registrados</h2>
      <div id="tablaClientes"></div>
      <button class="back-btn" onclick="showSection('ventasMenu')">Volver al submenú anterior</button>
    </div>

    <!-- Clientes con Deudas -->
    <div id="clientesDeuda" class="hidden">
      <h2>Clientes con Deudas</h2>
      <div id="tablaDeudas"></div>
      <button class="back-btn" onclick="showSection('ventasMenu')">Volver al submenú anterior</button>
    </div>

    <!-- Informe de Ventas -->
    <div id="informeVentas" class="hidden">
      <h2>Informe de Ventas</h2>
      <div id="tablaVentas"></div>
      <button class="back-btn" onclick="showSection('ventasMenu')">Volver al submenú anterior</button>
    </div>
  </main>

  <script>
    const sheetdbEndpoint = 'https://sheetdb.io/api/v1/7merahzf5ighx';
    let ventasData = [];
    let clientesData = [];

    // Mostrar/Ocultar secciones
    function showSection(id) {
      document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'clientesRegistrados') renderClientes();
      if (id === 'clientesDeuda') renderDeudas();
      if (id === 'informeVentas') renderInforme();
    }

    // Cargar datos iniciales
    async function loadData() {
      try {
        const res = await fetch(sheetdbEndpoint);
        ventasData = await res.json();
        // datos para autocompletar
        clientesData = ventasData.map(v => ({
          cliente: v.cliente,
          telefono: v.telefono
        }));
        populateDatalists();
      } catch(e) {
        console.error('Error cargando datos:', e);
      }
    }

    // Autocomplete clientes y teléfonos
    function populateDatalists() {
      const uniqueClientes = [...new Set(clientesData.map(c => c.cliente))];
      const uniqueTels = [...new Set(clientesData.map(c => c.telefono))];
      const dlC = document.getElementById('clientes-list');
      const dlT = document.getElementById('telefonos-list');
      dlC.innerHTML = uniqueClientes.map(n => `<option value="${n}">`).join('');
      dlT.innerHTML = uniqueTels.map(t => `<option value="${t}">`).join('');
    }
    document.getElementById('cliente').addEventListener('change', () => {
      const sel = clientesData.find(c => c.cliente === document.getElementById('cliente').value);
      if (sel) document.getElementById('telefono').value = sel.telefono;
    });

    // Cálculo total y restante
    function updateTotal() {
      const c = parseFloat(document.getElementById('cantidad').value) || 0;
      const p = parseFloat(document.getElementById('precio').value) || 0;
      const tot = c * p;
      document.getElementById('total').value = tot.toFixed(2);
      updateRestante();
    }
    function updateRestante() {
      const tot = parseFloat(document.getElementById('total').value) || 0;
      const ab = parseFloat(document.getElementById('abono').value) || 0;
      document.getElementById('restante').value = (tot - ab).toFixed(2);
    }
    document.getElementById('cantidad').addEventListener('input', updateTotal);
    document.getElementById('precio').addEventListener('input', updateTotal);
    document.getElementById('abono').addEventListener('input', updateRestante);

    // Obtener tasa BCV
    async function fetchTasa() {
      try {
        const res = await fetch('https://s3.amazonaws.com/dolartoday/data.json');
        const json = await res.json();
        const tasa = json.USD.promedio_real || json.USD.transferencia;
        document.getElementById('tasa').value = parseFloat(tasa).toFixed(2);
        updateRestante();
      } catch(e) {
        console.error('Error al consultar BCV:', e);
      }
    }
    document.getElementById('metodo_pago').addEventListener('change', e => {
      if (e.target.value === 'Efectivo_Bs') {
        fetchTasa();
      } else {
        document.getElementById('tasa').value = '';
        updateRestante();
      }
    });

    // Enviar venta a Google Sheets
    async function enviarVenta(ev) {
      ev.preventDefault();
      const data = {
        data: {
          fecha: new Date().toISOString().split('T')[0],
          cliente: document.getElementById('cliente').value,
          telefono: document.getElementById('telefono').value,
          cantidad: parseFloat(document.getElementById('cantidad').value),
          precio_unitario: parseFloat(document.getElementById('precio').value),
          total: parseFloat(document.getElementById('total').value),
          metodo_pago: document.getElementById('metodo_pago').value,
          tasa: parseFloat(document.getElementById('tasa').value) || 0,
          abono: parseFloat(document.getElementById('abono').value) || 0,
          restante: parseFloat(document.getElementById('restante').value),
          asesor: document.getElementById('asesor').value,
          comentario: document.getElementById('comentario').value
        }
      };
      try {
        await fetch(sheetdbEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        alert('Venta registrada con éxito');
        await loadData();
        showSection('ventasMenu');
      } catch(err) {
        console.error(err);
        alert('Error al registrar la venta');
      }
    }

    function renderClientes() {
      const unique = [];
      ventasData.forEach(v => {
        if (!unique.find(u => u.cliente === v.cliente)) {
          unique.push({ cliente: v.cliente, telefono: v.telefono });
        }
      });
      let html = '<table><tr><th>Cliente</th><th>Teléfono</th></tr>';
      unique.forEach(c => {
        html += `<tr><td>${c.cliente}</td><td>${c.telefono}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('tablaClientes').innerHTML = html;
    }
    function renderDeudas() {
      const conDeuda = ventasData.filter(v => parseFloat(v.restante) > 0);
      let html = '<table><tr><th>Cliente</th><th>Teléfono</th><th>Restante</th></tr>';
      conDeuda.forEach(v => {
        html += `<tr><td>${v.cliente}</td><td>${v.telefono}</td><td>${v.restante}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('tablaDeudas').innerHTML = html;
    }
    function renderInforme() {
      let html = '<table><tr><th>Fecha</th><th>Cliente</th><th>Cant.</th><th>Precio</th><th>Total</th><th>Pago</th><th>Abono</th><th>Restante</th></tr>';
      ventasData.forEach(v => {
        html += `<tr><td>${v.fecha}</td><td>${v.cliente}</td><td>${v.cantidad}</td><td>${v.precio_unitario}</td><td>${v.total}</td><td>${v.metodo_pago}</td><td>${v.abono}</td><td>${v.restante}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('tablaVentas').innerHTML = html;
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html>
