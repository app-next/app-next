<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ventas - NEXT</title></head><body>
<h2>Registrar Venta</h2>
<form onsubmit="enviarVenta(event)">
  <input id="cliente" placeholder="Cliente" required><br>
  <input id="telefono" placeholder="Teléfono" required><br>
  <input id="producto" placeholder="Producto" required><br>
  <input id="cantidad" type="number" placeholder="Cantidad" required><br>
  <input id="precio_unitario" type="number" placeholder="Precio Unitario" required><br>
  <input id="total_usd" placeholder="Total USD" readonly><br>
  <select id="metodo_pago_1">
    <option value="">Método Pago 1</option><option>USD</option><option>BS</option><option>Zinli</option><option>USDT</option>
  </select><br>
  <input id="monto_pago_1" type="number" placeholder="Monto Pago 1"><br>
  <select id="metodo_pago_2">
    <option value="">Método Pago 2</option><option>USD</option><option>BS</option><option>Zinli</option><option>USDT</option>
  </select><br>
  <input id="monto_pago_2" type="number" placeholder="Monto Pago 2"><br>
  <input id="tasa_bcv" type="number" placeholder="Tasa BCV"><br>
  <input id="abono_usd" placeholder="Abono USD" readonly><br>
  <input id="restante_usd" placeholder="Restante USD" readonly><br>
  <input id="asesor" placeholder="Asesor"><br>
  <textarea id="comentario" placeholder="Comentario"></textarea><br>
  <button type="submit">Registrar</button>
</form>
<script>
document.getElementById('cantidad').addEventListener('input', calcularTotal);
document.getElementById('precio_unitario').addEventListener('input', calcularTotal);
document.getElementById('monto_pago_1').addEventListener('input', calcularAbono);
document.getElementById('monto_pago_2').addEventListener('input', calcularAbono);
function calcularTotal() {
  let c = parseFloat(document.getElementById('cantidad').value) || 0;
  let p = parseFloat(document.getElementById('precio_unitario').value) || 0;
  document.getElementById('total_usd').value = (c * p).toFixed(2);
  calcularAbono();
}
function calcularAbono() {
  let p1 = parseFloat(document.getElementById('monto_pago_1').value) || 0;
  let p2 = parseFloat(document.getElementById('monto_pago_2').value) || 0;
  let total = parseFloat(document.getElementById('total_usd').value) || 0;
  let abono = p1 + p2;
  document.getElementById('abono_usd').value = abono.toFixed(2);
  document.getElementById('restante_usd').value = Math.max(0, total - abono).toFixed(2);
}
function enviarVenta(e) {
  e.preventDefault();
  const d = {
    cliente: cliente.value, telefono: telefono.value, producto: producto.value,
    cantidad: cantidad.value, precio_unitario: precio_unitario.value, total_usd: total_usd.value,
    metodo_pago_1: metodo_pago_1.value, monto_pago_1: monto_pago_1.value,
    metodo_pago_2: metodo_pago_2.value, monto_pago_2: monto_pago_2.value,
    tasa_bcv: tasa_bcv.value, abono_usd: abono_usd.value, restante_usd: restante_usd.value,
    asesor: asesor.value, comentario: comentario.value
  };
  if ((d.monto_pago_1 > 0 && !d.metodo_pago_1) || (d.monto_pago_2 > 0 && !d.metodo_pago_2)) {
    alert("Debes seleccionar método de pago si hay monto.");
    return;
  }
  if ((d.metodo_pago_1 === "BS" || d.metodo_pago_2 === "BS") && (!d.tasa_bcv || d.tasa_bcv == 0)) {
    alert("Indica tasa BCV para pagos en BS.");
    return;
  }
  fetch("https://script.google.com/macros/s/AKfycbwVyOMe5KcCsnkLq2kxDoh4zU42XRYrHD3dwvdw-HF6G1kg8fXC0rNPdhO1Fjy96TFbDg/exec", {
    method: "POST",
    body: JSON.stringify(d),
    headers: { "Content-Type": "application/json" }
  }).then(r => r.text()).then(msg => {
    alert("Venta registrada correctamente.");
    document.querySelector("form").reset();
    total_usd.value = ""; abono_usd.value = ""; restante_usd.value = "";
  }).catch(err => alert("Error: " + err.message));
}
</script>
</body></html>