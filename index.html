<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>APP NEXT – SpreadAPI v21</title>
  <style>
    :root {--black:#000;--white:#fff;--blue:#0033A0;--yellow:#FFD700;--gray-bg:#f5f5f5;--red:#E63946;}
    *,*:before,*:after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:sans-serif;background:var(--gray-bg);display:flex;flex-direction:column;min-height:100vh;}
    header{background:var(--black);text-align:center;padding:1rem;}
    header .logo{height:50px;}
    main{flex:1;max-width:900px;margin:1rem auto;background:var(--white);padding:1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .menu,.submenu{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem;}
    .menu .btn,.submenu .subbtn{padding:.75rem;background:var(--blue);color:var(--white);border:none;border-radius:6px;font-size:1rem;cursor:pointer;text-align:center;width:100%;}
    .menu .btn:hover,.submenu .subbtn:hover{background:var(--yellow);color:var(--black);}
    .hidden{display:none!important;}
    form{display:flex;flex-direction:column;gap:.5rem;max-width:600px;margin:auto;}
    label{font-weight:500;font-size:.9rem;margin-top:.5rem;}
    input,select,textarea{padding:.5rem;font-size:1rem;border:1px solid #ccc;border-radius:6px;width:100%;}
    input[readonly]{background:#eee;}
    #restante.negative{color:var(--red);} .nota{font-size:.9rem;color:var(--red);text-align:right;}
    .form-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem;}
    .form-btn{padding:.5rem 1rem;border:none;border-radius:6px;font-size:1rem;cursor:pointer;}
    .submit-btn{background:var(--blue);color:var(--white);} .submit-btn:hover{background:var(--yellow);color:var(--black);} .back-btn{background:#444;color:var(--white);} .back-btn:hover{background:var(--yellow);color:var(--black);}
    table{width:100%;border-collapse:collapse;margin-top:1rem;} th,td{border:1px solid #ccc;padding:.5rem;text-align:left;}
  </style>
</head>
<body>
<header><img src="logo.png" alt="NEXT Logo" class="logo"></header>
<main>
  <!-- MENÚ PRINCIPAL -->
  <div id="mainMenu" class="menu">
    <button class="btn" data-section="ventasMenu">Ventas</button>
    <button class="btn">CRM</button><button class="btn">Diseños</button><button class="btn">Stock</button>
    <button class="btn">Compras</button><button class="btn">Finanzas</button><button class="btn">Marketing</button>
    <button class="btn">Agenda</button>
  </div>
  <!-- SUBMENÚ VENTAS -->
  <div id="ventasMenu" class="submenu hidden">
    <button class="subbtn" data-section="formVenta">Registrar Venta</button>
    <button class="subbtn" data-section="clientesRegistrados">Clientes Registrados</button>
    <button class="subbtn" data-section="clientesDeuda">Clientes con Deudas</button>
    <button class="subbtn" data-section="informeVentas">Informe de Ventas</button>
    <button class="subbtn back-btn" data-section="mainMenu">Volver</button>
  </div>
  <!-- FORM VENTA -->
  <div id="formVenta" class="hidden">
    <h2>Registrar Venta</h2>
    <form id="ventaForm" onsubmit="return enviarVenta(event)">
      <label>Cliente<input list="clientes-list" id="cliente" required autocomplete="off"><datalist id="clientes-list"></datalist></label>
      <label>Teléfono<input list="telefonos-list" id="telefono" type="tel" inputmode="numeric" required autocomplete="off"><datalist id="telefonos-list"></datalist></label>
      <label>Producto<input id="producto" required></label>
      <label>Cantidad<input id="cantidad" type="number" min="1" step="1" required value="1"></label>
      <label>Precio Unitario (USD)<input id="precio" type="number" step="0.01" required value="0"></label>
      <label>Tasa BCV<input id="tasa" type="number" step="0.01" value="1"></label>
      <label>Total USD<input id="total" readonly></label>
      <label>Método de Pago 1<select id="metodo1" required><option value="" disabled selected>Selecciona Método</option><option value="Efectivo_$">Efectivo $</option><option value="BS">BS</option><option value="Zinli">Zinli</option><option value="USDT">USDT</option></select></label>
      <label>Monto Pago 1<input id="monto1" type="number" step="0.01" value="0" required></label>
      <label>Método de Pago 2<select id="metodo2"><option value="">Ninguno</option><option value="Efectivo_$">Efectivo $</option><option value="BS">BS</option><option value="Zinli">Zinli</option><option value="USDT">USDT</option></select></label>
      <label>Monto Pago 2<input id="monto2" type="number" step="0.01" value="0"></label>
      <label>Abono Total USD<input id="abono" readonly></label>
      <label>Restante USD<input id="restante" readonly></label>
      <div id="nota" class="nota"></div>
      <label>Asesor<input id="asesor" required></label>
      <label>Comentarios<textarea id="comentario"></textarea></label>
      <div class="form-actions"><button type="button" class="form-btn back-btn" data-section="ventasMenu">Volver</button><button type="submit" class="form-btn submit-btn">Enviar</button></div>
    </form>
  </div>
  <!-- PANELES LISTADOS -->
  <div id="clientesRegistrados" class="hidden"><h2>Clientes Registrados</h2><div id="tablaClientes"></div><div class="form-actions"><button class="form-btn back-btn" data-section="ventasMenu">Volver</button></div></div>
  <div id="clientesDeuda" class="hidden"><h2>Clientes con Deudas</h2><div id="tablaDeudas"></div><div class="form-actions"><button class="form-btn back-btn" data-section="ventasMenu">Volver</button></div></div>
  <div id="informeVentas" class="hidden"><h2>Informe de Ventas</h2><div id="tablaVentas"></div><div class="form-actions"><button class="form-btn back-btn" data-section="ventasMenu">Volver</button></div></div>
</main>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwVyOMe5KcCsnkLq2kxDoh4zU42XRYrHD3dwvdw-HF6G1kg8fXC0rNPdhO1Fjy96TFbDg/exec';
let ventasData = [], clientesData = [];
let rawPrecio = 0, rawMonto1 = 0, rawMonto2 = 0, rawTasa = 1;

/* ---------- NAVEGACIÓN DE SECCIONES ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('[data-section]').forEach(btn=>btn.addEventListener('click',()=>show(btn.dataset.section)));
  loadVentas();
  calcular();
  // listeners de cálculo
  ['cantidad','precio','tasa','monto1','monto2','metodo1','metodo2'].forEach(id=>document.getElementById(id).addEventListener('input',calcular));
  document.getElementById('cliente').addEventListener('change',autocompletarTelefono);
});
function show(id){['mainMenu','ventasMenu','formVenta','clientesRegistrados','clientesDeuda','informeVentas'].forEach(s=>document.getElementById(s).classList.add('hidden'));document.getElementById(id).classList.remove('hidden'); if(id!=='mainMenu' && id!=='ventasMenu')renderTablas(id);} /*MAIN*/

/* ---------- LECTURA DE HOJA “Ventas” ---------- */
async function loadVentas(){
  const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({method:'GET',sheet:'Ventas'})});
  ventasData = await res.json();
  clientesData = ventasData.map(v=>({cliente:v.cliente,telefono:v.telefono}));
  poblarDatalists();
}
function poblarDatalists(){
  document.getElementById('clientes-list').innerHTML=[...new Set(clientesData.map(c=>c.cliente))].map(c=>`<option value="${c}">`).join('');
  document.getElementById('telefonos-list').innerHTML=[...new Set(clientesData.map(c=>c.telefono))].map(t=>`<option value="${t}">`).join('');
}
function autocompletarTelefono(){const f=clientesData.find(c=>c.cliente===document.getElementById('cliente').value);if(f)document.getElementById('telefono').value=f.telefono;}

/* ---------- CÁLCULOS EN FORM ---------- */
function calcular(){
  const c=+document.getElementById('cantidad').value||0;
  rawPrecio=+document.getElementById('precio').value||0;
  rawTasa=+document.getElementById('tasa').value||1;
  rawMonto1=+document.getElementById('monto1').value||0;
  rawMonto2=+document.getElementById('monto2').value||0;
  const totalUSD = c*rawPrecio;
  document.getElementById('total').value = totalUSD.toFixed(2);
  // abono
  const m1=document.getElementById('metodo1').value, m2=document.getElementById('metodo2').value;
  let ab = 0;
  if(m1){ab += (m1==='BS'?rawMonto1/rawTasa:rawMonto1);} if(m2){ab += (m2==='BS'?rawMonto2/rawTasa:rawMonto2);} document.getElementById('abono').value=ab.toFixed(2);
  const restante = (totalUSD-ab).toFixed(2); document.getElementById('restante').value=restante; const nota=document.getElementById('nota'); if(restante<0){nota.textContent='Saldo a favor';document.getElementById('restante').classList.add('negative');}else{nota.textContent='';document.getElementById('restante').classList.remove('negative');}
}

/* ---------- REGISTRAR VENTA ---------- */
async function enviarVenta(e){e.preventDefault();
  const data = {
    fecha:new Date().toISOString().split('T')[0],
    cliente:document.getElementById('cliente').value,
    telefono:document.getElementById('telefono').value,
    producto:document.getElementById('producto').value,
    cantidad:+document.getElementById('cantidad').value,
    precio_unitario:+document.getElementById('precio').value,
    total:+document.getElementById('total').value,
    metodo_pago_1:document.getElementById('metodo1').value,
    monto_pago_1:+document.getElementById('monto1').value,
    metodo_pago_2:document.getElementById('metodo2').value,
    monto_pago_2:+document.getElementById('monto2').value,
    tasa_bcv:+document.getElementById('tasa').value||1,
    abono:+document.getElementById('abono').value,
    restante:+document.getElementById('restante').value,
    asesor:document.getElementById('asesor').value,
    comentario:document.getElementById('comentario').value
  };
  const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({method:'POST',sheet:'Ventas',payload:data})});
  if(res.ok){alert('Venta registrada');await loadVentas();show('ventasMenu');} else alert('Error al registrar');
}

/* ---------- TABLAS ---------- */
function renderTablas(sec){if(sec==='clientesRegistrados'){const html=[...new Set(ventasData.map(v=>v.cliente))].map(c=>`<tr><td>${c}</td><td>${ventasData.find(v=>v.cliente===c).telefono}</td></tr>`).join('');document.getElementById('tablaClientes').innerHTML=`<table><tr><th>Cliente</th><th>Teléfono</th></tr>${html}</table>`;} if(sec==='clientesDeuda'){const html=ventasData.filter(v=>+v.restante>0).map(v=>`<tr><td>${v.cliente}</td><td>${v.telefono}</td><td>${v.restante}</td></tr>`).join('');document.getElementById('tablaDeudas').innerHTML=`<table><tr><th>Cliente</th><th>Teléfono</th><th>Restante</th></tr>${html}</table>`;} if(sec==='informeVentas'){const rows=ventasData.map(v=>`<tr><td>${v.fecha}</td><td>${v.cliente}</td><td>${v.producto}</td><td>${v.cantidad}</td><td>${v.precio_unitario}</td><td>${v.total}</td><td>${v.metodo_pago_1}</td><td>${v.monto_pago_1}</td><td>${v.metodo_pago_2}</td><td>${v.monto_pago_2}</td><td>${v.tasa_bcv}</td><td>${v.abono}</td><td>${v.restante}</td></tr>`).join('');document.getElementById('tablaVentas').innerHTML=`<table><tr><th>Fecha</th><th>Cliente</th><th>Prod.</th><th>Cant</th><th>$
