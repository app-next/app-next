<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>APP NEXT</title>
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --blue: #0033A0;
      --yellow: #FFD700;
      --gray-bg: #f5f5f5;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      background: var(--gray-bg);
      color: var(--black);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--black);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 60px;
    }
    header .logo {
      height: 40px;
      object-fit: contain;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 900px;
      margin: auto;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .menu {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .menu .btn {
      flex: 1;
      min-width: 100px;
      height: 40px;
      background: var(--blue);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .menu .btn:hover {
      background: var(--yellow);
      color: var(--black);
    }
    .submenu {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
      width: 200px;
    }
    .submenu .subbtn {
      width: 100%;
      height: 40px;
      background: var(--blue);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .submenu .subbtn:hover {
      background: var(--yellow);
      color: var(--black);
    }
    .hidden { display: none !important; }
    form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 500px;
      margin: auto;
    }
    form label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    input, select, textarea {
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
    }
    .form-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    .form-actions .form-btn {
      flex: 0 0 120px;
      height: 40px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .submit-btn {
      background: var(--blue);
      color: var(--white);
    }
    .submit-btn:hover {
      background: var(--yellow);
      color: var(--black);
    }
    .back-btn {
      background: #444;
      color: var(--white);
    }
    .back-btn:hover {
      background: var(--yellow);
      color: var(--black);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="NEXT Logo" class="logo" />
  </header>
  <main>
    <div id="mainMenu" class="menu">
      <button class="btn" onclick="showSection('ventasMenu')">Ventas</button>
      <button class="btn">CRM</button>
      <button class="btn">Diseños</button>
      <button class="btn">Stock</button>
      <button class="btn">Compras</button>
      <button class="btn">Finanzas</button>
      <button class="btn">Marketing</button>
      <button class="btn">Agenda</button>
      <button class="btn">Reportes</button>
    </div>
    <div id="ventasMenu" class="submenu hidden">
      <button class="subbtn" onclick="showSection('formVenta')">Registrar Venta</button>
      <button class="subbtn" onclick="showSection('clientesRegistrados')">Clientes Registrados</button>
      <button class="subbtn" onclick="showSection('clientesDeuda')">Clientes con Deudas</button>
      <button class="subbtn" onclick="showSection('informeVentas')">Informe de Ventas</button>
      <button class="subbtn back-btn" onclick="showSection('mainMenu')">Volver</button>
    </div>

    <div id="formVenta" class="hidden">
      <h2>Registrar Venta</h2>
      <form onsubmit="enviarVenta(event)">
        <label for="cliente">Cliente</label>
        <input list="clientes-list" id="cliente" required />
        <datalist id="clientes-list"></datalist>

        <label for="telefono">Teléfono</label>
        <input list="telefonos-list" id="telefono" required />
        <datalist id="telefonos-list"></datalist>

        <label for="producto">Producto</label>
        <input id="producto" required />

        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" min="1" required />

        <label for="precio">Precio Unitario</label>
        <input type="number" id="precio" min="0.01" step="0.01" required />

        <label for="total">Total</label>
        <input type="number" id="total" readonly />

        <label for="metodo1">Método de Pago 1</label>
        <select id="metodo1" required>
          <option value="Efectivo_$">Efectivo $</option>
          <option value="BS">BS</option>
          <option value="Zinli">Zinli</option>
          <option value="USDT">USDT</option>
        </select>

        <label for="monto1">Monto Pago 1</label>
        <input type="number" id="monto1" min="0" step="0.01" required />

        <label for="metodo2">Método de Pago 2 (opcional)</label>
        <select id="metodo2">
          <option value="">Ninguno</option>
          <option value="Efectivo_$">Efectivo $</option>
          <option value="BS">BS</option>
          <option value="Zinli">Zinli</option>
          <option value="USDT">USDT</option>
        </select>

        <label for="monto2">Monto Pago 2</label>
        <input type="number" id="monto2" min="0" step="0.01" />

        <label for="tasa">Tasa BCV (ingresar manualmente)</label>
        <input type="number" id="tasa" min="0" step="0.01" />

        <label for="abono">Abono Total (USD)</label>
        <input type="number" id="abono" readonly />

        <label for="restante">Restante (USD)</label>
        <input type="number" id="restante" readonly />

        <label for="asesor">Asesor</label>
        <input id="asesor" required />

        <label for="comentario">Comentarios</label>
        <textarea id="comentario" rows="3"></textarea>

        <div class="form-actions">
          <button type="button" class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button>
          <button type="submit" class="form-btn submit-btn">Enviar</button>
        </div>
      </form>
    </div>

    <div id="clientesRegistrados" class="hidden">
      <h2>Clientes Registrados</h2>
      <div id="tablaClientes"></div>
      <div class="form-actions">
        <button class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button>
      </div>
    </div>

    <div id="clientesDeuda" class="hidden">
      <h2>Clientes con Deudas</h2>
      <div id="tablaDeudas"></div>
      <div class="form-actions">
        <button class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button>
      </div>
    </div>

    <div id="informeVentas" class="hidden">
      <h2>Informe de Ventas</h2>
      <div id="tablaVentas"></div>
      <div class="form-actions">
        <button class="form-btn back-btn" onclick="showSection('ventasMenu')">Volver</button>
      </div>
    </div>
  </main>

  <script>
    const endpoint = 'https://sheetdb.io/api/v1/7merahzf5ighx';
    let ventasData = [], clientesData = [];

    function showSection(id) {
      document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'formVenta') calculateTotal();
      if (id === 'clientesRegistrados') renderClientes();
      if (id === 'clientesDeuda') renderDeudas();
      if (id === 'informeVentas') renderInforme();
    }

    async function loadData() {
      try {
        const r = await fetch(endpoint);
        ventasData = await r.json();
        clientesData = ventasData.map(v=>({cliente:v.cliente,telefono:v.telefono}));
        populateDatalists();
      } catch(e){console.error(e);}
    }

    function populateDatalists(){
      const cList = [...new Set(clientesData.map(c=>c.cliente))];
      const tList = [...new Set(clientesData.map(c=>c.telefono))];
      document.getElementById('clientes-list').innerHTML = cList.map(x=>`<option value="${x}">`).join('');
      document.getElementById('telefonos-list').innerHTML = tList.map(x=>`<option value="${x}">`).join('');
    }
    document.getElementById('cliente').addEventListener('change', ()=>{
      const sel = clientesData.find(c=>c.cliente===document.getElementById('cliente').value);
      if(sel) document.getElementById('telefono').value = sel.telefono;
    });

    function calculateTotal(){
      const c = parseFloat(document.getElementById('cantidad').value)||0;
      const p = parseFloat(document.getElementById('precio').value)||0;
      document.getElementById('total').value = (c*p).toFixed(2);
      updateAbonoRestante();
    }

    ['cantidad','precio'].forEach(id=>{
      document.getElementById(id).addEventListener('input', calculateTotal);
    });

    ['metodo1','metodo2','monto1','monto2','tasa'].forEach(id=>{
      document.getElementById(id).addEventListener('input', updateAbonoRestante);
    });

    function updateAbonoRestante(){
      const total = parseFloat(document.getElementById('total').value)||0;
      const tasa = parseFloat(document.getElementById('tasa').value)||0;
      let abonoUsd = 0;
      [
        {met:document.getElementById('metodo1').value, val:parseFloat(document.getElementById('monto1').value)||0},
        {met:document.getElementById('metodo2').value, val:parseFloat(document.getElementById('monto2').value)||0}
      ].forEach(p=>{
        abonoUsd += (p.met==='BS' && tasa>0) ? p.val/tasa : p.val;
      });
      document.getElementById('abono').value = abonoUsd.toFixed(2);
      document.getElementById('restante').value = (total - abonoUsd).toFixed(2);
    }

    async function enviarVenta(ev){
      ev.preventDefault();
      const abono = parseFloat(document.getElementById('abono').value)||0;
      const tasa = parseFloat(document.getElementById('tasa').value)||0;
      const eqUsdBs = parseFloat((parseFloat(document.getElementById('monto2').value)||0)*( (document.getElementById('metodo2').value==='BS'&&tasa>0)?1/tasa:0 ).toFixed(2)) || 0;
      const data = {
        data: {
          fecha:new Date().toISOString().split('T')[0],
          cliente:document.getElementById('cliente').value,
          telefono:document.getElementById('telefono').value,
          producto:document.getElementById('producto').value,
          cantidad:parseFloat(document.getElementById('cantidad').value),
          precio_unitario:parseFloat(document.getElementById('precio').value),
          total:parseFloat(document.getElementById('total').value),
          metodo_pago_1:document.getElementById('metodo1').value,
          monto_pago_1:parseFloat(document.getElementById('monto1').value)||0,
          metodo_pago_2:document.getElementById('metodo2').value||'',
          monto_pago_2:parseFloat(document.getElementById('monto2').value)||0,
          tasa_bcv:tasa,
          equivalente_usd_bs:eqUsdBs,
          abono:abono,
          restante:parseFloat(document.getElementById('restante').value),
          asesor:document.getElementById('asesor').value,
          comentario:document.getElementById('comentario').value
        }
      };
      try {
        const r = await fetch(endpoint,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data)
        });
        if(!r.ok) throw new Error('HTTP '+r.status);
        alert('Venta registrada con éxito');
        await loadData();
        showSection('ventasMenu');
      } catch(e) {
        console.error(e);
        alert('Error al registrar la venta');
      }
    }

    function renderClientes(){
      const uniq=[];
      ventasData.forEach(v=>{
        if(!uniq.find(u=>u.cliente===v.cliente)) uniq.push(v);
      });
      let html='<table><tr><th>Cliente</th><th>Teléfono</th></tr>';
      uniq.forEach(u=>html+=`<tr><td>${u.cliente}</td><td>${u.telefono}</td></tr>`);
      html+='</table>';
      document.getElementById('tablaClientes').innerHTML=html;
    }
    function renderDeudas(){
      const con=ventasData.filter(v=>parseFloat(v.restante)>0);
      let html='<table><tr><th>Cliente</th><th>Teléfono</th><th>Restante</th></tr>';
      con.forEach(v=>html+=`<tr><td>${v.cliente}</td><td>${v.telefono}</td><td>${v.restante}</td></tr>`);
      html+='</table>';
      document.getElementById('tablaDeudas').innerHTML=html;
    }
    function renderInforme(){
      let html='<table><tr><th>Fecha</th><th>Cliente</th><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th><th>P1</th><th>M1</th><th>P2</th><th>M2</th><th>Tasa</th><th>EqUSD</th><th>Abono</th><th>Restante</th></tr>';
      ventasData.forEach(v=>html+=`<tr><td>${v.fecha}</td><td>${v.cliente}</td><td>${v.producto}</td><td>${v.cantidad}</td><td>${v.precio_unitario}</td><td>${v.total}</td><td>${v.metodo_pago_1}</td><td>${v.monto_pago_1}</td><td>${v.metodo_pago_2||''}</td><td>${v.monto_pago_2||''}</td><td>${v.tasa_bcv}</td><td>${v.equivalente_usd_bs}</td><td>${v.abono}</td><td>${v.restante}</td></tr>`);
      html+='</table>';
      document.getElementById('tablaVentas').innerHTML=html;
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      loadData();
    });
  </script>
</body>
</html>
