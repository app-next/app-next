
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>APP NEXT – Ventas</title>
  <style>
    :root {
      --azul: #0033A0;
      --amarillo: #FFD700;
      --rojo: #E63946;
      --gris: #f5f5f5;
      --blanco: #fff;
      --negro: #000;
    }
    body {
      font-family: sans-serif;
      background: var(--gris);
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--negro);
      text-align: center;
      padding: 1rem;
    }
    header img {
      height: 50px;
    }
    main {
      flex: 1;
      max-width: 600px;
      margin: auto;
      background: var(--blanco);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--azul);
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-size: 0.9rem;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 0.25rem;
    }
    input[readonly] {
      background: #eee;
    }
    .btn {
      margin-top: 1.5rem;
      background: var(--azul);
      color: var(--blanco);
      border: none;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
    }
    .btn:hover {
      background: var(--amarillo);
      color: var(--negro);
    }
    .negativo {
      color: var(--rojo);
      font-weight: bold;
    }
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="NEXT" />
</header>
<main>
  <h2>Registrar Venta</h2>
  <form id="formVenta">
    <label>Cliente:
      <input id="cliente" list="dlClientes" autocomplete="off" required>
      <datalist id="dlClientes"></datalist>
    </label>
    <label>Teléfono:
      <input id="telefono" autocomplete="off" required>
    </label>
    <label>Producto:
      <input id="producto" required>
    </label>
    <label>Cantidad:
      <input id="cantidad" type="number" min="1" value="1" required>
    </label>
    <label>Precio USD:
      <input id="precio" type="number" step="0.01" value="0" required>
    </label>
    <label>Total USD:
      <input id="total" readonly>
    </label>
    <label>Método de Pago 1:
      <select id="metodo1">
        <option value="">— elige —</option>
        <option value="Efectivo USD">Efectivo USD</option>
        <option value="BS">BS</option>
        <option value="Zinli">Zinli</option>
        <option value="Pago Móvil">Pago Móvil</option>
        <option value="USDT">USDT</option>
      </select>
    </label>
    <label>Monto 1:
      <input id="monto1" type="number" step="0.01" value="0">
    </label>
    <label>Método de Pago 2:
      <select id="metodo2">
        <option value="">Ninguno</option>
        <option value="Efectivo USD">Efectivo USD</option>
        <option value="BS">BS</option>
        <option value="Zinli">Zinli</option>
        <option value="Pago Móvil">Pago Móvil</option>
        <option value="USDT">USDT</option>
      </select>
    </label>
    <label>Monto 2:
      <input id="monto2" type="number" step="0.01" value="0">
    </label>
    <label>Tasa BCV:
      <input id="tasa" type="number" step="0.01">
    </label>
    <label>Abono USD:
      <input id="abono" readonly>
    </label>
    <label>Restante USD:
      <input id="restante" readonly class="negativo">
    </label>
    <label>Asesor:
      <input id="asesor" required>
    </label>
    <label>Comentario:
      <textarea id="comentario" rows="2"></textarea>
    </label>
    <button type="submit" class="btn">Registrar Venta</button>
  </form>
</main>
<script>
const API = 'https://script.google.com/macros/s/AKfycbzyZ4XgVMvjZoX6QUYmNKyyIkbnhdVXd-MtfTZOzysWpSXRvH9ZXQE_-OSxGlg--LOK1A/exec';
let clientes = [];

document.addEventListener('DOMContentLoaded', ()=>{
  fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({method:'GET',sheet:'Ventas'})
  }).then(res=>res.json()).then(data=>{
    clientes = data;
    let opciones = [...new Set(data.map(c=>c.cliente))];
    document.getElementById('dlClientes').innerHTML = opciones.map(c=>`<option value="${c}">`).join('');
  });

  document.getElementById('cliente').addEventListener('change', ()=>{
    const encontrado = clientes.find(c=>c.cliente === document.getElementById('cliente').value);
    if(encontrado) document.getElementById('telefono').value = encontrado.telefono;
  });

  ['cantidad','precio','monto1','monto2','metodo1','metodo2','tasa'].forEach(id=>{
    document.getElementById(id).addEventListener('input', calcular);
  });

  document.getElementById('formVenta').addEventListener('submit', enviarVenta);
});

function calcular(){
  let cantidad = +document.getElementById('cantidad').value || 0;
  let precio = +document.getElementById('precio').value || 0;
  let total = cantidad * precio;
  document.getElementById('total').value = total.toFixed(2);

  let m1 = document.getElementById('metodo1').value;
  let m2 = document.getElementById('metodo2').value;
  let v1 = +document.getElementById('monto1').value || 0;
  let v2 = +document.getElementById('monto2').value || 0;
  let tasa = +document.getElementById('tasa').value || 0;

  if(m1 === 'BS') v1 = tasa > 0 ? v1 / tasa : 0;
  if(m2 === 'BS') v2 = tasa > 0 ? v2 / tasa : 0;

  let abono = v1 + v2;
  document.getElementById('abono').value = abono.toFixed(2);
  document.getElementById('restante').value = (total - abono).toFixed(2);
}

function enviarVenta(e){
  e.preventDefault();

  const m1 = document.getElementById('metodo1').value;
  const m2 = document.getElementById('metodo2').value;
  const v1 = +document.getElementById('monto1').value;
  const v2 = +document.getElementById('monto2').value;
  const tasa = +document.getElementById('tasa').value;

  if((m1 === 'BS' || m2 === 'BS') && !tasa){
    alert('Debes ingresar la tasa BCV si hay método BS');
    return;
  }
  if((v1 > 0 && !m1) || (v2 > 0 && !m2)){
    alert('Debes seleccionar el método de pago correspondiente al monto');
    return;
  }

  const data = {
    fecha: new Date().toISOString().split('T')[0],
    cliente: cliente.value,
    telefono: telefono.value,
    producto: producto.value,
    cantidad: +cantidad.value,
    precio_unitario: +precio.value,
    total_usd: +total.value,
    metodo_pago_1: m1,
    monto_pago_1: +v1,
    metodo_pago_2: m2,
    monto_pago_2: +v2,
    tasa_bcv: tasa,
    abono_usd: +abono.value,
    restante_usd: +restante.value,
    asesor: asesor.value,
    comentario: comentario.value
  };

  fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({method:'POST',sheet:'Ventas',payload:data})
  }).then(res=>{
    if(res.ok){ alert('Venta registrada'); location.reload(); }
    else alert('Error al registrar');
  });
}
</script>
</body>
</html>
